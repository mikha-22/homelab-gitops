# apps/system/online-boutique-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: online-boutique
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "20"  # Deploy after all infrastructure
spec:
  project: default
  source:
    repoURL: https://github.com/GoogleCloudPlatform/microservices-demo
    targetRevision: v0.10.1
    path: release
    kustomize:
      # Add OpenTelemetry environment variables and ingress
      patches:
        # Patch each microservice with OpenTelemetry configuration
        - target:
            kind: Deployment
            name: adservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "adservice"
        
        - target:
            kind: Deployment
            name: cartservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "cartservice"
        
        - target:
            kind: Deployment
            name: checkoutservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "checkoutservice"
        
        - target:
            kind: Deployment
            name: currencyservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "currencyservice"
        
        - target:
            kind: Deployment
            name: emailservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "emailservice"
        
        - target:
            kind: Deployment
            name: frontend
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "frontend"
        
        - target:
            kind: Deployment
            name: paymentservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "paymentservice"
        
        - target:
            kind: Deployment
            name: productcatalogservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "productcatalogservice"
        
        - target:
            kind: Deployment
            name: recommendationservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "recommendationservice"
        
        - target:
            kind: Deployment
            name: shippingservice
          patch: |
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_EXPORTER_OTLP_ENDPOINT
                value: "http://otel-collector-opentelemetry-collector.monitoring.svc.cluster.local:4317"
            - op: add
              path: /spec/template/spec/containers/0/env/-
              value:
                name: OTEL_SERVICE_NAME
                value: "shippingservice"
        
        # Add ingress for the frontend
        - patch: |
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: online-boutique-frontend
              namespace: online-boutique
              annotations:
                kubernetes.io/ingress.class: "traefik"
                external-dns.alpha.kubernetes.io/target: "52e6c172-8b5e-4167-b68f-20dd50299c3c.cfargotunnel.com"
                external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
                traefik.ingress.kubernetes.io/router.middlewares: "monitoring-security-headers@kubernetescrd"
            spec:
              rules:
              - host: shop.milenika.dev
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: frontend
                        port:
                          number: 80
              tls:
              - secretName: online-boutique-tls
                hosts:
                - shop.milenika.dev
    
  destination:
    server: https://kubernetes.default.svc
    namespace: online-boutique
    
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 5m
