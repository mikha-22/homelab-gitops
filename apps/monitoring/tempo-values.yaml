# apps/monitoring/tempo-values.yaml (ADDING LOCAL-BLOCKS PROCESSOR)

replicas: 1

persistence:
  enabled: true
  storageClassName: local-path
  size: 10Gi

serviceMonitor:
  enabled: true

# Use the chart's built-in metrics generator support
tempo:
  ingester:
    trace_idle_period: 60s
    flush_check_period: 60s
    max_block_duration: 15m
  # Enable metrics generator - THIS IS THE KEY!
  metricsGenerator:
    enabled: true
    remoteWriteUrl: "http://prometheus-stack-kube-prom-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"

  # Server configuration
  server:
    http_listen_port: 3200

  # Resource configuration
  resources:
    requests:
      cpu: 500m
      memory: 4Gi
    limits:
      cpu: 1000m
      memory: 8Gi

  # Other Tempo settings
  multitenancyEnabled: false
  reportingEnabled: false
  retention: 48h
  memBallastSizeMbs: 2048

  # Storage configuration (keep the defaults working)
  storage:
    trace:
      backend: local
      local:
        path: /var/tempo/traces
      wal:
        path: /var/tempo/wal

  # CRITICAL: Enable metrics generation with ALL required processors
  overrides:
    defaults:
      metrics_generator:
        processors: 
          - "span-metrics"
          - "service-graphs"
          - "local-blocks"  # ADD THIS - Required for TraceQL metrics drilldown

  # Health check configuration
  livenessProbe:
    httpGet:
      path: /ready
      port: 3200
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1
    
  readinessProbe:
    httpGet:
      path: /ready
      port: 3200
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1
